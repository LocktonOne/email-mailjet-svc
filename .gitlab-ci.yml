services:
- docker:dind

variables:
  IMAGE_NAME: registry.gitlab.com/tokend/notifications/email-mailjet-svc:$CI_COMMIT_SHA

stages:
- build

# build and publish docker image to the registry
build:
  image: docker:latest
  stage: build
  tags:
  - tokend
  script:
  - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  - version=$(test -z $CI_COMMIT_TAG && echo $CI_COMMIT_SHA || echo $CI_COMMIT_TAG)
  - docker build --build-arg VERSION="$version" --pull -t $IMAGE_NAME .
  - docker push $IMAGE_NAME

